<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Playlist + Downloader YouTube para MP3</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --card: #1e293b;
        --text: #e2e8f0;
        --accent: #22c55e;
        --danger: #ef4444;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: radial-gradient(circle at top, #1e293b, var(--bg));
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 1rem;
      }

      .app {
        width: min(900px, 100%);
        background: color-mix(in srgb, var(--card) 92%, black);
        border: 1px solid #334155;
        border-radius: 14px;
        padding: 1rem;
      }

      h1 {
        margin-top: 0;
        font-size: 1.6rem;
      }

      .grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .panel {
        background: color-mix(in srgb, var(--card) 80%, black);
        border: 1px solid #334155;
        border-radius: 10px;
        padding: 0.9rem;
      }

      label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }

      input, button {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #475569;
        padding: 0.6rem 0.7rem;
        font: inherit;
      }

      input {
        margin-bottom: 0.6rem;
        background: #0b1220;
        color: var(--text);
      }

      button {
        background: #1f2937;
        color: var(--text);
        cursor: pointer;
      }

      button.primary { background: var(--accent); color: #052e16; font-weight: 700; }
      button.danger { background: var(--danger); color: white; }
      button:disabled { opacity: 0.55; cursor: not-allowed; }

      .video-shell {
        width: min(360px, 100%);
        aspect-ratio: 9 / 16;
        margin-inline: auto;
      }

      video {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        border: 1px solid #334155;
        background: black;
        object-fit: cover;
      }

      ol { margin: 0; padding-left: 1.4rem; }
      li { margin: 0.35rem 0; }

      .controls {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(2, 1fr);
      }

      .status {
        margin: 0.7rem 0 0;
        font-size: 0.9rem;
        color: #93c5fd;
      }

      small { color: #94a3b8; }
    </style>
  </head>
  <body>
    <main class="app">
      <h1>Playlist de Vídeos Curtos + YouTube para MP3</h1>

      <div class="grid">
        <section class="panel">
          <h2>Adicionar por URL</h2>
          <label for="title">Título</label>
          <input id="title" placeholder="Ex.: Gol de bicicleta" />

          <label for="url">URL de vídeo (.mp4, .webm...)</label>
          <input id="url" placeholder="https://exemplo.com/video-curto.mp4" />

          <button class="primary" id="addUrlBtn">Adicionar URL à playlist</button>

          <hr />

          <h2>Ou adicionar arquivos locais</h2>
          <label for="fileInput">Selecione vídeos curtos</label>
          <input id="fileInput" type="file" accept="video/*" multiple />
          <button id="addFilesBtn">Adicionar arquivos à playlist</button>
          <small>
            Dica: para URLs externas, use arquivos com CORS permitido.
          </small>

          <hr />

          <h2>Baixar YouTube em MP3</h2>
          <label for="youtubeUrl">URL do vídeo do YouTube</label>
          <input id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." />

          <label for="apiEndpoint">API (opcional)</label>
          <input id="apiEndpoint" value="https://co.wuk.sh/api/json" />

          <button id="downloadMp3Btn">Baixar e converter para MP3</button>
          <small>
            Esta opção usa uma API externa para extrair o áudio do link e iniciar o download.
          </small>
        </section>

        <section class="panel">
          <div class="video-shell">
            <video id="player" controls playsinline></video>
          </div>

          <div class="controls" style="margin-top: 0.8rem;">
            <button class="primary" id="playRandomBtn">Tocar aleatório</button>
            <button id="nextRandomBtn">Próximo aleatório</button>
          </div>

          <p class="status" id="status">Nenhum vídeo carregado.</p>

          <h3>Playlist</h3>
          <ol id="playlistView"></ol>
        </section>
      </div>
    </main>

    <script>
      const titleInput = document.getElementById('title');
      const urlInput = document.getElementById('url');
      const fileInput = document.getElementById('fileInput');
      const addUrlBtn = document.getElementById('addUrlBtn');
      const addFilesBtn = document.getElementById('addFilesBtn');
      const playRandomBtn = document.getElementById('playRandomBtn');
      const nextRandomBtn = document.getElementById('nextRandomBtn');
      const youtubeUrlInput = document.getElementById('youtubeUrl');
      const apiEndpointInput = document.getElementById('apiEndpoint');
      const downloadMp3Btn = document.getElementById('downloadMp3Btn');
      const playlistView = document.getElementById('playlistView');
      const player = document.getElementById('player');
      const statusEl = document.getElementById('status');

      const playlist = [];
      let randomQueue = [];
      let current = null;

      function updateButtons() {
        const hasItems = playlist.length > 0;
        playRandomBtn.disabled = !hasItems;
        nextRandomBtn.disabled = !hasItems;
      }

      function renderPlaylist() {
        playlistView.innerHTML = '';
        playlist.forEach((item, index) => {
          const li = document.createElement('li');
          li.textContent = `${index + 1}. ${item.title}`;
          playlistView.appendChild(li);
        });
        updateButtons();
      }

      function resetRandomQueue() {
        randomQueue = playlist.map((_, idx) => idx);
        for (let i = randomQueue.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [randomQueue[i], randomQueue[j]] = [randomQueue[j], randomQueue[i]];
        }
      }

      function getNextRandomIndex() {
        if (playlist.length === 0) return null;
        if (randomQueue.length === 0) {
          resetRandomQueue();
        }
        return randomQueue.pop();
      }

      function playByIndex(index) {
        current = playlist[index];
        if (!current) return;

        player.src = current.src;
        player.play().catch(() => {
          // Alguns navegadores bloqueiam autoplay sem interação do usuário.
        });

        statusEl.textContent = `Tocando: ${current.title}`;
      }

      function playNextRandom() {
        const idx = getNextRandomIndex();
        if (idx === null) {
          statusEl.textContent = 'Playlist vazia.';
          return;
        }
        playByIndex(idx);
      }

      function addVideo(title, src) {
        playlist.push({ title, src });
        renderPlaylist();
        statusEl.textContent = `${playlist.length} vídeo(s) na playlist.`;
      }

      addUrlBtn.addEventListener('click', () => {
        const src = urlInput.value.trim();
        if (!src) {
          statusEl.textContent = 'Informe uma URL válida.';
          return;
        }
        const title = titleInput.value.trim() || `Vídeo ${playlist.length + 1}`;
        addVideo(title, src);
        titleInput.value = '';
        urlInput.value = '';
      });

      addFilesBtn.addEventListener('click', () => {
        const files = [...fileInput.files];
        if (files.length === 0) {
          statusEl.textContent = 'Selecione ao menos um arquivo de vídeo.';
          return;
        }

        files.forEach((file) => {
          const blobUrl = URL.createObjectURL(file);
          addVideo(file.name, blobUrl);
        });
        fileInput.value = '';
      });

      playRandomBtn.addEventListener('click', playNextRandom);
      nextRandomBtn.addEventListener('click', playNextRandom);

      downloadMp3Btn.addEventListener('click', async () => {
        const youtubeUrl = youtubeUrlInput.value.trim();
        const apiEndpoint = apiEndpointInput.value.trim() || 'https://co.wuk.sh/api/json';

        if (!youtubeUrl) {
          statusEl.textContent = 'Informe uma URL do YouTube para baixar o MP3.';
          return;
        }

        downloadMp3Btn.disabled = true;
        statusEl.textContent = 'Convertendo e preparando download...';

        try {
          const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({
              url: youtubeUrl,
              isAudioOnly: true,
              aFormat: 'mp3',
            }),
          });

          const payload = await response.json();
          if (!response.ok || payload.status === 'error') {
            throw new Error(payload.text || 'A API recusou a conversão.');
          }

          const downloadUrl = payload.url || payload.audio || payload.file;
          if (!downloadUrl) {
            throw new Error('Resposta da API sem link de download.');
          }

          const a = document.createElement('a');
          a.href = downloadUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.download = '';
          document.body.appendChild(a);
          a.click();
          a.remove();

          statusEl.textContent = 'Download do MP3 iniciado.';
        } catch (error) {
          statusEl.textContent = `Não foi possível baixar MP3: ${error.message}`;
        } finally {
          downloadMp3Btn.disabled = false;
        }
      });

      player.addEventListener('ended', () => {
        playNextRandom();
      });

      updateButtons();
    </script>
  </body>
</html>
